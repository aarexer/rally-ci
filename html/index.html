<!DOCTYPE html>
<head>
<title>Rally-CI</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<style type="text/css">

body {font-family: sans;}
table#jobs thead tr th:nth-child(1) {width: 5em; }
table#jobs thead tr th:nth-child(2) {width: 12em; }
table#jobs thead tr th:nth-child(4) {width: 34em; }
table#jobs { width: 90%; border-collapse: collapse; }
table#jobs tbody tr td { font-family: monospace; }
table tr td { border: 1px solid; padding: 1pt 2pt; }

</style>
<script type="text/javascript">

function render_job(job) {
    return "<span id='"+ job.id +"'>"+ job.name +"("+ job.status +"),</span>";
}

function add_task(t) {
    var jobs = "";
    for (var i=0, job; job = t["jobs"][i]; i++) {
        jobs += render_job(job);
    }
    var html = "<tr id='"+t.id+"'><td><a href='/logs/"+t.id+"/'>"+t.id+"</a></td>";
    html += "<td>"+t.project+"</td>";
    html += "<td>"+t.subject+"</td>";
    html += "<td>"+jobs+"</td>";
    html += "</tr>";
    $('#jobs > tbody:last').append(html);
}

function connect_ws() {

    var ws = new WebSocket("ws://" + window.location.host + "/ws/");
    var interval;

    ws.onmessage = function(e) {
        var d = JSON.parse(e.data);
        console.log(d);
        switch(d["type"]) {
            case "task-started":
                add_task(d["task"]);
                break;
            case "task-finished":
                $("#" + d["id"]).remove();
                break;
            case "all-tasks":
                $("#jobs > tbody > tr").remove();
                for (var i=0, item; item = d["tasks"][i]; i++) {
                    add_task(item);
                }
                break;
            case "job-status-update":
                var job = d["job"];
                $("#" + job.id).replaceWith(render_job(job));
                break;
            default:
                console.log(d);
        }
    };

    ws.onopen = function(e) {
        interval = setInterval(function () {ws.send("ping")}, 50000);
        document.title = "RallyCI (online)";
    }

    ws.onerror = function(e) {
        console.log(e);
    }

    ws.onclose = function(e) {
        console.log("Websocket is closed. Reconnecting in 3 seconds.");
        clearInterval(interval);
        window.setTimeout(connect_ws, 3000);
        document.title = "RallyCI (offline)";
    }
}

connect_ws();

</script>
</head>

<body>

<h3>Active jobs</h3>

<table id="jobs">
    <thead><tr><th>Id</th><th>Project</th><th>Subject</th><th>Jobs</th></th></thead>
    <tbody></tbody>
</table>

</body>
</html>
