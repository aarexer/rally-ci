<!DOCTYPE html>
<head>
<title>Rally-CI</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<style type="text/css">

body {font-family: sans-serif; margin: 0; padding: 0;}
#jobs { width: 100%; }
#jobs div { width: 40em; border-collapse: collapse; margin: 1em; float: left; margin: 2pt; padding: 0; }
#jobs div table { width: 100%; margin: 0; padding: 0; border-collapse: collapse; }
#jobs div table tr td:nth-child(1) { width: 20em; }
#jobs div table tr td { font-family: monospace; border: 1px solid; margin: 0; }

</style>
<script type="text/javascript">

function Task(task) {
    this.t = task;

    this.render = function (id) {
        var html = "<div id='"+this.t.id+"'>";
        html += "<table>";
        html += "<tr><td colspan=2>"+this.t.project;
        html += ": <a href='"+t.url+"'>"+this.t.subject+"</a></td></tr>";
        for (var i=0, job; job = this.t["jobs"][i]; i++) {
            html += "<tr><td><a href='/logs/"+this.t.id+"/"+job.name+"/'>"
            html += job.name+"</a></td><td id='"+job.id+"'>"
            html += job.status+"</td></tr>";
        }
        html += "<tr></tr>";
        html += "</table>";
        html += "</div>";
        $("#" + id).prepend(html);
    }

    this.update = function (job) {
        $("#"+job.id).html(job.status);
    }

    this.clear = function () {
        $("#" + this.task.id).remove();
    }
}

function Tasks() {
    this._tasks = {};
    this._finished = [];

    this.add = function(task) {
        this._tasks[task.id] = new Task(task);
    }

    this.finished = function(id) {
        var task = this._tasks[id];
        delete this._tasks[id];
        this._finished.unshift(task);
    }

    this.update = function(job) {
        //
    }

}

function update_job(job) {
}

function ci_status_update(ci_status) {
    document.title = "RallyCI ("+ci_status+")";
}

function connect_ws() {

    var ws = new WebSocket("ws://" + window.location.host + "/ws/");
    var interval;

    ws.onmessage = function(e) {
        var d = JSON.parse(e.data);
        console.log(d);
        switch(d["type"]) {
            case "task-started":
                add_task(d["task"]);
                break;
            case "task-finished":
                $("#" + d["id"]).remove();
                break;
            case "all-tasks":
                $("#jobs tbody tr").remove();
                for (var i=0, item; item = d["tasks"][i]; i++) {
                    add_task(item);
                }
                break;
            case "job-status-update":
                var job = d["job"];
                update_job(job);
                break;
            default:
                console.log(d);
        }
    };

    ws.onopen = function(e) {
        interval = setInterval(function () {ws.send("ping")}, 50000);
        ci_status_update("online");
    }

    ws.onerror = function(e) {
        console.log(e);
    }

    ws.onclose = function(e) {
        console.log("Websocket is closed. Reconnecting in 3 seconds.");
        clearInterval(interval);
        window.setTimeout(connect_ws, 3000);
        ci_status_update("offline");
    }
}

connect_ws();

</script>
</head>

<body>
<h1>Rally CI</h1>
<div id="jobs"></div>

</body>
</html>
